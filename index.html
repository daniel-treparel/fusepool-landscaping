<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <link rel="stylesheet" href="/css/landscape.css">
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.1/themes/base/jquery-ui.css" />
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="http://code.jquery.com/ui/1.10.1/jquery-ui.js"></script>
    <script type="text/javascript" src="js/jsondata.js"></script>
    <script type="text/javascript" src="js/three.js"></script>
    <script type="x-shader/x-vertex" id="vertexshader">
        varying vec2 pixel;

        void main(void) {

            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
            pixel = uv;

        }
    </script>
    <script type="x-shader/x-fragment" id="fragmentshaderH">
        uniform sampler2D src_tex;
        uniform vec2 pixelSize;
        uniform float sigma;

        varying vec2 pixel;

        void main(void) {

            float h = sigma * pixelSize.x;
            vec4 sum = vec4(0.0);

            sum += texture2D(src_tex, vec2(pixel.x - 9.0*h, pixel.y) ) * 0.008074244714835564;
            sum += texture2D(src_tex, vec2(pixel.x - 8.0*h, pixel.y) ) * 0.01373475292908177;
            sum += texture2D(src_tex, vec2(pixel.x - 7.0*h, pixel.y) ) * 0.02194807268686863;
            sum += texture2D(src_tex, vec2(pixel.x - 6.0*h, pixel.y) ) * 0.032947959470316014;
            sum += texture2D(src_tex, vec2(pixel.x - 5.0*h, pixel.y) ) * 0.0464640702427165;
            sum += texture2D(src_tex, vec2(pixel.x - 4.0*h, pixel.y) ) * 0.06155489208605796;
            sum += texture2D(src_tex, vec2(pixel.x - 3.0*h, pixel.y) ) * 0.07660630093247092;
            sum += texture2D(src_tex, vec2(pixel.x - 2.0*h, pixel.y) ) * 0.08956183951296363;
            sum += texture2D(src_tex, vec2(pixel.x - 1.0*h, pixel.y) ) * 0.09836443747572207;
            sum += texture2D(src_tex, vec2(pixel.x + 0.0*h, pixel.y) ) * 0.10148685989793388;
            sum += texture2D(src_tex, vec2(pixel.x + 1.0*h, pixel.y) ) * 0.09836443747572207;
            sum += texture2D(src_tex, vec2(pixel.x + 2.0*h, pixel.y) ) * 0.08956183951296363;
            sum += texture2D(src_tex, vec2(pixel.x + 3.0*h, pixel.y) ) * 0.07660630093247092;
            sum += texture2D(src_tex, vec2(pixel.x + 4.0*h, pixel.y) ) * 0.06155489208605796;
            sum += texture2D(src_tex, vec2(pixel.x + 5.0*h, pixel.y) ) * 0.0464640702427165;
            sum += texture2D(src_tex, vec2(pixel.x + 6.0*h, pixel.y) ) * 0.032947959470316014;
            sum += texture2D(src_tex, vec2(pixel.x + 7.0*h, pixel.y) ) * 0.02194807268686863;
            sum += texture2D(src_tex, vec2(pixel.x + 8.0*h, pixel.y) ) * 0.01373475292908177;
            sum += texture2D(src_tex, vec2(pixel.x + 9.0*h, pixel.y) ) * 0.008074244714835564;

            gl_FragColor = sum;

        }

    </script>
    <script type="x-shader/x-fragment" id="fragmentshaderV">

        uniform sampler2D src_tex;
        uniform sampler2D dmap_tex;
        uniform vec2 pixelSize;
        uniform float sigma;

        varying vec2 pixel;

        void main(void) {

            float v = sigma * pixelSize.y;
            vec4 sum = vec4(0.0);

            sum += texture2D(src_tex, vec2(pixel.x, - 9.0*v + pixel.y) ) * 0.008074244714835564;
            sum += texture2D(src_tex, vec2(pixel.x, - 8.0*v + pixel.y) ) * 0.01373475292908177;
            sum += texture2D(src_tex, vec2(pixel.x, - 7.0*v + pixel.y) ) * 0.02194807268686863;
            sum += texture2D(src_tex, vec2(pixel.x, - 6.0*v + pixel.y) ) * 0.032947959470316014;
            sum += texture2D(src_tex, vec2(pixel.x, - 5.0*v + pixel.y) ) * 0.0464640702427165;
            sum += texture2D(src_tex, vec2(pixel.x, - 4.0*v + pixel.y) ) * 0.06155489208605796;
            sum += texture2D(src_tex, vec2(pixel.x, - 3.0*v + pixel.y) ) * 0.07660630093247092;
            sum += texture2D(src_tex, vec2(pixel.x, - 2.0*v + pixel.y) ) * 0.08956183951296363;
            sum += texture2D(src_tex, vec2(pixel.x, - 1.0*v + pixel.y) ) * 0.09836443747572207;
            sum += texture2D(src_tex, vec2(pixel.x, + 0.0*v + pixel.y) ) * 0.10148685989793388;
            sum += texture2D(src_tex, vec2(pixel.x, + 1.0*v + pixel.y) ) * 0.09836443747572207;
            sum += texture2D(src_tex, vec2(pixel.x, + 2.0*v + pixel.y) ) * 0.08956183951296363;
            sum += texture2D(src_tex, vec2(pixel.x, + 3.0*v + pixel.y) ) * 0.07660630093247092;
            sum += texture2D(src_tex, vec2(pixel.x, + 4.0*v + pixel.y) ) * 0.06155489208605796;
            sum += texture2D(src_tex, vec2(pixel.x, + 5.0*v + pixel.y) ) * 0.0464640702427165;
            sum += texture2D(src_tex, vec2(pixel.x, + 6.0*v + pixel.y) ) * 0.032947959470316014;
            sum += texture2D(src_tex, vec2(pixel.x, + 7.0*v + pixel.y) ) * 0.02194807268686863;
            sum += texture2D(src_tex, vec2(pixel.x, + 8.0*v + pixel.y) ) * 0.01373475292908177;
            sum += texture2D(src_tex, vec2(pixel.x, + 9.0*v + pixel.y) ) * 0.008074244714835564;

            //sum = vec4(0.6);
            gl_FragColor = /*vec4(pixel * vec2(0.6), 0, 0.1) + */texture2D(dmap_tex, vec2(sum.a, 0));
            gl_FragColor.a = 1.0;
        }

    </script>
        <script>
            var container;
            var scene, scenePing, scenePong, camera, renderer, geometry, material, sprite, radius,
                particles, rtTexturePing, rtTexturePong, uniformsH, uniformsV;

            var update = true;
            var scale = 1;

            var h = 1.0 / window.innerWidth;
            var v = 1.0 / window.innerHeight;

            function onload() {
                console.log("Initializing Landscape Component");
                initUI();
                initThree();
                update = true;
                animate();
            }

            function initUI() {
                $( "#slider_scale" ).slider({
                    orientation: "horizontal",
                    slide: function( event, ui ) {
                        scale = 2.0 / (100.0 / ui.value);
                        update = true;
                        console.log("scale: " + scale);
                    }
                });
                $( "#slider_sigma" ).slider({
                    orientation: "horizontal",
                    slide: function( event, ui ) {
                        uniformsH.sigma.value = (100.0 / ui.value);
                        uniformsV.sigma.value = uniformsH.sigma.value;
                        update = true;
                        console.log("sigma: " + uniformsH.sigma.value);
                    }
                });
            }
            
            function initThree() {

                scene = new THREE.Scene();
                scenePing = new THREE.Scene();
                scenePong = new THREE.Scene();

                camera = new THREE.OrthographicCamera(window.innerWidth / -2, window.innerWidth / 2, window.innerHeight / 2, window.innerHeight / -2, -1, 1);
                camera.position.z = 0;

                var tex_options = {
                    magFilter: THREE.LinearFilter,
                    minFilter:THREE.LinearFilter,
                    generateMipmaps: false
                };
                rtTexturePing = new THREE.WebGLRenderTarget(window.innerWidth, window.innerHeight, tex_options);
                rtTexturePong = new THREE.WebGLRenderTarget(window.innerWidth, window.innerHeight, tex_options);

                var dmap = THREE.ImageUtils.loadTexture("img/dmap.png");
                uniformsH = {
                    sigma: { type:"f", value: 1 },
                    src_tex: { type: "t", value: rtTexturePing },
                    pixelSize: { type: "v2", value: new THREE.Vector2(h,v)}
                };
                var shaderMaterialPing = new THREE.ShaderMaterial({
                    uniforms: uniformsH,
                    vertexShader: document.getElementById('vertexshader').textContent,
                    fragmentShader: document.getElementById('fragmentshaderH').textContent

                });
                uniformsV = {
                        sigma: { type:"f", value: 1 },
                        src_tex: { type: "t", value: rtTexturePong },
                        dmap_tex: { type: "t", value: dmap },
                        pixelSize: { type: "v2", value: new THREE.Vector2(h,v)}
                    };
                var shaderMaterialPong = new THREE.ShaderMaterial({
                    uniforms: uniformsV,
                    vertexShader: document.getElementById('vertexshader').textContent,
                    fragmentShader: document.getElementById('fragmentshaderV').textContent

                });


                radius = 10;
                particles = jsondata.rows.length;

                var geometry = new THREE.BufferGeometry();
                geometry.attributes = {

                    position: {
                        itemSize: 3,
                        array: new Float32Array(particles * 3),
                        numItems: particles * 3
                    },
                    color: {
                        itemSize: 3,
                        array: new Float32Array(particles * 3),
                        numItems: particles * 3
                    }

                };

                var positions = geometry.attributes.position.array;
                var colors = geometry.attributes.color.array;

                for (var i = 0; i < particles; i++) {

                    var pos = 3 * i;

                    // positions

                    positions[pos] = ((0.15+jsondata.rows[i].PX) * window.innerHeight) - (window.innerHeight / 2);
                    positions[pos + 1] = ((-0.2+jsondata.rows[i].PY) * window.innerHeight) - (window.innerHeight / 2);
                    positions[pos + 2] = 0;

                    // colors

                    colors[pos] = 1;
                    colors[pos + 1] = 0;
                    colors[pos + 2] = 0;

                }

                geometry.computeBoundingSphere();
                
                sprite = THREE.ImageUtils.loadTexture("img/dot.png");

                var material = new THREE.ParticleBasicMaterial({ size: radius, map: sprite, sizeAttenuation: false, transparent: true, vertexColors: true });

                particleSystem = new THREE.ParticleSystem(geometry, material);
                scene.add(particleSystem);

                var plane = new THREE.PlaneGeometry(window.innerWidth, window.innerHeight);
                var quadPing = new THREE.Mesh(plane, shaderMaterialPing);
                var quadPong = new THREE.Mesh(plane, shaderMaterialPong);
                scenePing.add(quadPing);
                scenePong.add(quadPong);

                renderer = new THREE.WebGLRenderer({ antialias: false, clearAlpha: 0, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);

                document.body.appendChild(renderer.domElement);

                document.addEventListener('mousewheel', onMouseWheelHandler, false);
                document.addEventListener('click', clickHandler, false);

            }

            function onMouseWheelHandler(event) {
                update = true;
                /*
                scale = scale + (0.1 * (event.wheelDelta / 120));
                */
                d = - 0.05 * (event.wheelDelta / 120.0);
                camera.left *= 1.0+d;
                camera.right *= 1.0+d;
                camera.top *= 1.0+d;
                camera.bottom *= 1.0+d;
                camera.updateProjectionMatrix();
                console.log(d, camera.left)
            }

            //

            function clickHandler(event) {
                update = true;
                scale = 1;
            }

            function animate() {

                requestAnimationFrame(animate);

                if (update) {

                    scene.children[0].material.size = radius * scale;


                    renderer.render(scene, camera, rtTexturePing, true);
                    renderer.render(scenePing, camera, rtTexturePong, true);
                    renderer.render(scenePong, camera);

                    update = false;
                }

            }
        </script>
</head>
	<body onload="onload();">
        <div id="slider_scale"></div>
        <div id="slider_sigma"></div>
    </body>
</html>
